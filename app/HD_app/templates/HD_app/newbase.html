{% load static %}
{% load rest_framework %}
<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Styles -->
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/jquery-ui.css' %}" />
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="{% static 'css/owl.carousel.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/owl.theme.default.min.css' %}" />
  
  <link rel="stylesheet" href="{% static 'css/animate.css' %}" />
  <link rel="stylesheet" href="{% static 'css/jquery.datetimepicker.min.css' %}" />
  <link rel="stylesheet" href="{% static 'fullcalendar/core/main.css' %}" rel='stylesheet' />
  <link rel="stylesheet" href="{% static 'fullcalendar/daygrid/main.css' %}" rel='stylesheet' />
  <link rel="stylesheet" href="{% static 'css/style2.css' %}" rel='stylesheet' />

  
  <link href="{% static 'css/all.css' %}" rel="stylesheet" />
  <script defer src="{% static 'js/all.js' %}"></script>
  
  <title>
    {% block title %}{% endblock %}
  </title>
</head>

<body class="bg-noisy" id="bodyid">

{% block modals %}{% endblock %}
<div class="fixed-top toggler">
          <div class="">
            <button type="button" id="sidebarCollapse" class="text-left btn btn-primary btn-block btn-circle">
              <i class="fa fa-bars"></i>
              <span class="sr-only">Toggle Menu</span>
              </button>
          </div>
        </div>

<!-- Modal -->
  <div class="modal fade" id="modalload" tabindex="-1" role="dialog" aria-labelledby="modalloadTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalloadLongTitle">Pobieram z subiekta...</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center">
          <h1><i class="fas fa-circle-notch fa-spin"></i></h1>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Zamknij</button>
        </div>
      </div>
    </div>
  </div>



<!-- Content -->
  <div class="content" id="content"  autofocus>
    <div class="wrapper d-flex align-items-stretch">
      {% if user.is_authenticated %}
      <!-- NAVBAR -->
        <nav id="sidebar">
          <div class="p-4 pt-5">
            <div class="m-auto rounded-circle d-flex justify-content-center text-center">

            <div id="main-logo" class="logos">
              <img src="{% static 'img/sokol_logo.png' %}" alt="Avatar" width=100 class="logo">
              <div class="overlay">
                <a href="#" class="icon" title="User Profile">
                <div id="#spinner">
                </div>
                  <i style="display:none;" class="fas fa-circle-notch fa-spin text-warning"></i>
                </a>
              </div>
            </div>
             
            </div>
            <div class="shadow-sm rounded text-middle border-dotted mt-1 mb-3">
              <div class="d-flex justify-content-center text-middle">
                
                   
                <div class="log"></div>
              </div>
              <div>
              <a class="font-weight-bold text-center" href="#"><div class="subiekt-status"></div></a>
              </div>
            </div>
            <ul class="list-unstyled components mb-5">
            <!-- ALL -->

              <li>
                <a class="font-weight-bold" href="{% url 'DashboardView' %}"><i class="text-danger fas fa-list"
                    aria-hidden="true"></i>
                  Dashboard</a>
                  <div id="spinner"></div>
              </li>

            <!-- STAFF ONLY -->
              {% if user.is_staff %}
              <li>
                <a class="font-weight-bold" class="font-weight-bold" href="{% url 'api-router' %}" target="_blank"><i
                    class="fa text-danger fa-plug" aria-hidden="true"></i>
                  Przeglądarka API</a>
              </li>
              <li>
                <a class="font-weight-bold" href="{% url 'admin-page' %}" target="_blank"><i
                    class="fa text-danger fa-th-list" aria-hidden="true"></i> CMS</a>
              </li>
              <li class="active">
                <a class="font-weight-bold" href="#kartSubmenu" data-toggle="collapse" aria-expanded="false"
                  class="dropdown-toggle"><i class="fas fa-folder-open text-danger" aria-hidden="true"></i>
                  &nbsp;&nbsp;Kartoteka</a>
                <ul class="collapse list-unstyled" id="kartSubmenu">
                  <li>
                    <a class="font-weight-bold" href="{% url 'User_add' %}"><i class="fas fa-users text-primary"></i>
                      Użytkownicy </a>
                    <a class="font-weight-bold" href="{% url 'SubiektCompany_add' %}"><i class="fas fa-building text-primary"
                        aria-hidden="true"></i> Firmy </a>
                  </li>
                </ul>
              </li>

                  <li>
                    <a class="font-weight-bold align-middle text-wrap" href="{% url 'Order_add' %}"><i class="fas text-danger fa-clipboard-list"
                      aria-hidden="true"></i> Moje zlecenia</a>
                  </li>
                  <li>
                    <a class="font-weight-bold align-middle text-wrap" href="{% url 'Raport' %}"><i class="fas text-danger fa-clipboard-list"
                      aria-hidden="true"></i> Rozliczanie</a>
                  </li>
              
              <li class="active">
                <a class="font-weight-bold" href="#raportSubmenu" data-toggle="collapse" aria-expanded="false"
                  class="dropdown-toggle"><i class="fa text-danger fa-question" aria-hidden="true"></i>
                  &nbsp;&nbsp;Faq</a>
                <ul class="collapse list-unstyled" id="raportSubmenu">
                  <li>
                    <a href="https://trello.com/b/ZSPZ0uwO/appsokol"><i class="fa text-primary fa-question" aria-hidden="true"></i>Trello</a>
                  </li>
                  <li>
                    <a href="https://github.com/coconutcake/sokol2"><i class="fa text-primary fa-question" aria-hidden="true"></i>Github</a>
                  </li>
                </ul>
              </li>
                  <li>
                    <a class="font-weight-bold align-middle text-wrap" href="{% url 'logout' %}"><i class="fa text-danger fa-plug"
                      aria-hidden="true"></i> Wyloguj</a>
                  </li>
                  
              

              {% endif %}
            </ul>


            <div class="footer text-left">

              <p>Aplikacja Sokół (Nowa Sowa) Gobit</p>
              <img class="rounded-circle" src="{% static 'img/logogb.jpg' %}" width=25 />
              <span class="text-sm-left text-secondary">P.I.E.S.E GOBIT<br>
                ul. Walczaka 20, 66-400 Gorzów Wlkp., <br>tel. 95 735 05 00, <br>email: info@gobit.com.pl, www.gobit.com.pl,
                NIP 599-100-54-02</span>
            </div>
            <div class="mt-4">
            </div>
          </div>
        </nav>

      <!-- CONTENT  -->
        <div id="content" class="">
      <!-- NAVBAR UPPER -->
      
        
      
    </nav> 

        {% block content %}
        {% endblock %}
        </div>

      {% else %}
      
        <div class="container mt-5">
          <div class="row justify-content-md-center">
            <div class="col">
            </div>
            <div class="col-md-auto text-center">
            <img class="text-center" src="{% static 'img/sokolm.png' %}" width=100 alt="logo">
            <h2>Zaloguj do platformy</h2>
              <hr>
                <form method="post">
                {% csrf_token %}
                <div class="text-center">
                  <div class="">
                    <div class="mt-3">
                      <div class="">Email:</div>
                      <div class="">{{ form.username }}</div>
                      
                    </div>
                  <div class="mt-3">
                    <div class="">Hasło:</div>
                    <div class="">{{ form.password }}</div>
                  </div>
                  </div>
                </div>
                <br>
                <button class="btn btn-danger" type="submit">Zaloguj</button>
              </form>
            </div>
            <div class="col">
            </div>
          </div>
        </div>


      {% endif %}
    </div>
    </div>
  </div>
<!-- SCRIPT -->
  <script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
  <script src="{% static 'js/jquery-ui.min.js' %}"></script>
  <script src="{% static 'js/csrf.js' %}"></script>
  <script src="{% static 'js/inputmask.min.js' %}"></script>
  <script src="{% static 'js/jquery.inputmask.min.js' %}"></script>
  <script src="{% static 'js/popper.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/owl.carousel.js' %}"></script>
  <script src="{% static 'js/jquery.datetimepicker.full.js' %}"></script>
  <script src="{% static 'fullcalendar/core/main.js' %}"></script>
  <script src="{% static 'fullcalendar/daygrid/main.js' %}"></script>
  <script src="{% static 'js/owls.js' %}"></script>
  <script src="{% static 'js/jquery.cookie.js' %}"></script>
  <script src="{% static 'js/search.js' %}"></script>
  <script src="{% static 'js/bootstrap-notify.js' %}"></script>
  <script src="{% static 'js/main.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/date-pl-PL.js' %}"></script>
  <script src="{% static 'js/moment.js' %}"></script>
  <script src="{% static 'js/Chart.bundle.js' %}"></script>
  <script src="{% static 'js/chartjs-plugin-datalabels.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mojs/core"></script>



  <!-- SCRIPT -->
    <script>
    $(document).ready(function () {
      // Ping animation
        const circ = new mojs.Shape({
          shape:        'circle',
          left:         '50%',
          top:          '-390%',
          parent:       '#spinner',
          scale:         { 0 : 1 },
          duration:      500,
          delay: 400,
          radius:       20,
          easing:        'cubic.in',
        });


        const rect = new mojs.Shape({
          shape:        'rect',
          left:         '50%',
          top:          '-390%',
          parent:       '#spinner',
          scale: {4:1},
          fill:         'none',
          radius:       50,
          stroke:       { 'yellow' : 'orange' },
          strokeWidth:  { 40: 0 },
          angle:        { 0: 40 },
          duration:     600,
          delay: 400,
          easing:        'cubic.inout',
        }).then({
          duration:     70,
          strokeWidth:  { 10: 0 },
          stroke:       { 'white' : 'none' },
          repeat: 2
        }).then({
          angle:        { 40: 80 },
          duration:     2000,
          strokeWidth:  { 4: 0 },
          stroke:       { 'yellow' : 'none' },
          scale: {1:1.2},
          easing:        'cubic.inout',
          repeat: 999
        })
      

      //$("#sidebar ul li").addClass("animated fadeInDown faster")
      $("#main-logo").addClass("animated zoomIn fast")
      $('a.hideafterclick').on('click', function(){
        $('body').addClass('animated fadeOut faster')
      })
      //$('div.content').addClass('animated fadeIn faster').show()
      // Fullscreen ----------------------------------
        var elem = document.getElementById("bodyid");
        function openFullscreen() {
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
          } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
          }
        }
        $(".full-screen").on("click",function(){
          openFullscreen();
        });
      // Dark-mode -----------------------------------
        // click
          $('.dark-mode').on('click',function(e){
            var $content = $("#content");
            enable_dark()
            if($content.hasClass("dark-mode-bg-1")){
              $.cookie("dark-mode", true, {
                path    : '/',
              });
              console.log($.cookie("dark-mode"));
            } else {
              $.cookie("dark-mode", false, {
                path    : '/',
              });
              console.log($.cookie("dark-mode"));
            }
            });
        // enable
          function enable_dark(){
            $('#content').toggleClass('dark-mode-bg-1'); 
            enable_dark_list()
            $(".action-bar-list button, .action-bar-list a").toggleClass("btn-dark")
            $(".fixed-top button").toggleClass("btn-danger")
            $('.subiekt-section-row').toggleClass('dark-mode-bg-1'); 
            $('.action-bar-header').toggleClass('dark-mode-bg-3'); 
            $('.subiekt-section-column').toggleClass('dark-mode-bg-2'); 
            $('.action-bar-items').toggleClass('dark-mode-bg-3');
            $('.action-bar-header h2').toggleClass('dark-mode-headers-1');
            $('.section-header span').toggleClass('dark-mode-spans-1');
            $('label').toggleClass('dark-mode-font-1');
            $("#sidebar").toggleClass('dark-mode-nav')
            $("hr").toggleClass('dark-mode-hr')
          }
          function enable_dark_list(){
            $('.ls_elem').toggleClass('dark-mode-bg-3');
            $('.ls_elem').toggleClass('dark-mode-hr-2');
            $('.ls_elem span').toggleClass('dark-mode-font-1');
            $('.ls_elem label').toggleClass('dark-mode-font-1');
          }
          function enable_dark_modal(){
            $('.modal-body').toggleClass('dark-mode-bg-3');
          }
        // init
          if($.cookie("dark-mode") == "true"){
            enable_dark()
          }

      // Zmienne -------------------------------------
        var user = "{{ user.username }}"
        var token = "{{ token }}"
        var loc = window.location.href;
        var $origin = document.location.origin;
        var $subiekturl = "{% url 'SubiektAPI' %}" 
      // Wejscie sekcji ------------------------------
        $('section').fadeIn();
      // Modyfikacja checkboxów ----------------------
        function correct_checkboxes(){
          $("input[type='checkbox']").each(function(){
            $(this).removeClass("form-control");
          });
        }
        $("input[type='checkbox']").each(function(){
          $(this).removeClass("form-control");
        })
      // Tooltipy ------------------------------------
       $('[data-toggle="tooltip"]').tooltip({
        placement: "auto", opacity: 0.7,
        track: true,
          delay: {
              show: 0,
              hide: 0
          }
          });
        $('.tooltip').addClass('animated zoomIn').show()

      // Subiekt URL ---------------------------------
 
      // AJAX subiekt-get-company --------------------
        $('a.subiekt-get-company').on('click',function(){
            var $th = $(this);
            $($th.attr("data-target")).modal("show");
            var $th_endpoint = $(this).attr("endpoint");
            var $th_endpoint2 = "kontrahencicrm"
            var $th_payload = $(this).attr("payload");
            var $th_keys_array = $th_payload.split(",");
            var $fields =  $(this).attr("fields");
            
            var $th_keys_values = []
            $($fields).each(function(index, value) {
              $th_val = $(this).val();
              $th_keys_values.push($th_val)
            });
            var $params = {}
            for ( var i = 0, l = $th_keys_array.length; i < l; i++ ) {
              $params[$th_keys_array[i]] = $th_keys_values[i]
            }

            // 1
            $params["endpoint"] = $th_endpoint


            $.ajax({
              url: $subiekturl,
              type: 'POST',
              data: $params,
              success: function(data){
                console.log(data);
                $(document).find("#id_name").val(data.data.Nazwa)
                $(document).find("#id_city").val(data.data.Miejscowosc)
                $(document).find("#id_ulica").val(data.data.Ulica)
                $(document).find("#id_nr_dom").val(data.data.NrDomu)
                $(document).find("#id_nr_lok").val(data.data.NrLokalu)
              }
            });

            // 2
            $params["endpoint"] = $th_endpoint2
            $('#id_pracownik').empty()
            $.ajax({
              url: $subiekturl,
              type: 'POST',
              data: $params,
              success: function(data){
                console.log(data);
                var opiekun = data.data.Opiekun;
                $("#id_care option:contains("+ opiekun +")").prop("selected", true);
                for (i = 0; i < data.data.Pracownicy.length; i++) {       
                    $('#id_pracownik').append('<option value='+data.data.Pracownicy[i].Email+' valuee='+i+'>'+data.data.Pracownicy[i].Imie+' '+data.data.Pracownicy[i].Nazwisko+' - '+data.data.Pracownicy[i].Email+'</option>');
                  }
                   setTimeout(function(){ $($th.attr("data-target")).modal("hide"); }, 1000);
              }
            });
            return false;
          });


      // Płynny show ---------------------------------
        $(".ih").each(function(index) {
          $(this).delay(70*index).fadeIn(300);
          });
        
        $(".section_title").each(function(index) {
          $(this).delay(70*index).hide().addClass('animated fadeIn').show(130)
          });
        //$("section input,select, textarea").each(function(index) {
        //  $(this).delay(70*index).hide().addClass('animated fadeIn fast').show(130)
        //  });
        //$("section.sec, .subiekt-section-column").each(function(index) {
        //  $(this).delay(70*index).hide().addClass('animated fadeInDown fast').show()
        //  });
        $(".ih2").each(function(index) {
          $(this).delay(100).delay(70*index).fadeIn(300);
          });
        $(".ls_elem,.collapse_sumy").hide()
        setTimeout(function(){
          $(".ls_elem,.field-group ul li,.collapse_sumy").each(function(index) {
            $(this).delay(70*index).hide().addClass('animated fadeIn').show(130)
          });
          },600); 

    
      // Searche -------------------------------------
        $("#k_search").on("keyup", function () {
          var value = $(this).val().toLowerCase();
          console.log(value)
          $(".ls .ls_elem").filter(function () {
            $(this).toggle($(this).find('span').text().toLowerCase().indexOf(value) > -1)
            console.log($(this).toggle($(this).find('span').text().toLowerCase().indexOf(value) > -1))
          });
          });

        $("#quick_search").on("keyup", function () {
          var value = $(this).val().toLowerCase();
          console.log(value)
          var $target = $(this).attr("target")
          var $elems = $(this).attr("elems")
          $($target).filter(function () {
            $(this).toggle($(this).find($elems).text().toLowerCase().indexOf(value) > -1)
            console.log($(this).toggle($(this).find($elems).text().toLowerCase().indexOf(value) > -1))
          });
          });
      
      // Daty ----------------------------------------
        function get_current_date(){
          var d = new Date();
          var strDate = d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
          return strDate;
          }
        function get_first_day_of_current_month(){
          var d = new Date();
          var firstDay = d.getFullYear() + "-" + (d.getMonth()+1) + "-" + (d.getDate(),1);
          return firstDay;
          }

      // Dodawanie klas css datepicker ---------------
      function set_datetime_fields(){
        $('textarea, input[type="text"], select').addClass('shadow-sm');
        $("textarea").addClass('bg-textarea')
        jQuery('input[name="start_datetime"], input[name="end_datetime"]').datetimepicker({
          format: 'Y-m-d H:i',
          step: 15,
        });
        jQuery('input[name="start_date"], input[name="end_date"], .dates').datetimepicker({
          format: 'Y-m-d',
        });

        $(function () {
          $(".datepicker").datepicker({
            dateFormat: 'yy-mm-dd',
          });
        });
      }
      set_datetime_fields()
      // Fukcje dodatkowe ----------------------------
        //
          function add_val(target,data){
            $(document).find(target).val(data)
            }
        //
          function purge(div) {
            var $div = div
            $($div).empty();
            console.log($div + " purged!")
            };
        //
          function updateDiv(target) {
            $(target).load(window.location.href + " " + target);
            };
        // --- Przedz do adresu
          function redirect(url){
            window.location.replace(url); 
            }
      // Serailizacja --------------------------------
        // --- Mapuj pola list ze sobą
          function map_to_dict(list1,list2){
            result = {};
            list1.forEach((key, i) => result[key] = list2[i]);
            return result;
            }
        // --- Serializuj zaznaczone spany
          function serialize_checked_spans(name){
            var $checkbox = $(document).find(".mark[name='"+name+"']:checked"); 
            var $li = [];
            $.each($checkbox,function(index){
              var $di = {};
              var $pk = $(this).attr("pk");
              $di['idf'] = $pk
              var $spans = $(document).find(".ls-spans[pk='"+$pk+"']");
              $.each($spans,function(index){
                var $name = $(this).attr("name");
                var $val = $(this).text();
                $di[$name] = $val
              });
              $li.push($di);
            });
            return $li
            }
        // --- Mapuj pola wkazanego formularza
          function map_form(form){
              var $form = form
              var $formdata = {};
              $($form).serializeArray().map(function(x){$formdata[x.name] = x.value;}); 
              return $formdata
              };

      // Marker --------------------------------------
        // --- Sprawdzy checkboxy formularza 
          function any_is_checked(name){
            if(get_checked_pks(name).length > 0){
              return true;
            } else {
              return false;
            }
            }
          function only_one_checked(name){
            console.log(name)
            console.log(get_checked_pks(name).length)
            if(get_checked_pks(name).length == 1){
              return true;
            } else {
              return false;
            }
            }
        // --- Popraw checkboxy
          function correct_checkboxes(){
                $("input[type='checkbox']").each(function(){
                  $(this).removeClass("form-control");
                });
              }
        // --- Wypełnij obszar kontentem
          function populate_modal_body(modal_body,content){
              $modal_body = $(modal_body)
              $modal_body.html(content);
            }
        // --- Nastaw licznik zaznaczonych
          function set_counter(target,list){
            var $target = target
            console.log("MARKED: "+list.length);
            $target.text("");
            if(list.length != "0"){
              $target.text("Zaznaczone: "+list.length);
            }
            }
        // --- Pobierz zaznaczone pk formularza
          function get_checked_pks(name){
            var $name = name
            var $list = [];
            var $checked = $(document).find(".mark[name='"+name+"']:checked")
            console.log("TO SA CHECKI")
            console.log($checked)
            console.log("KONIEC")
            $.each($(".mark[name='"+name+"']:checked"), function(){
              $list.push($(this).attr("pk"));
            });
            return $list;
            }
        // --- Pobierz wszystkie pk formularza
          function get_all_pks(name){
            var $name = name
            var $list = [];
            $.each($(".mark[name='"+name+"']"), function(){
              $list.push($(this).attr("pk"));
            });
            return $list;
            }
        // --- Pobierz niezaznaczone
          function get_unchecked_pks(name){
            var $name = name
            var $list = [];
            $.each($(".mark[name='"+name+"']:not(:checked)"), function(){
              $list.push($(this).attr("pk"));
            });
            return $list;
            }
        // --- Ukryj okno modalne
          function dissmis_modal(modal){
            $(modal).modal("hide");
            }
        // --- Pokaż okno modalne
          function show_modal(modal){
            $(modal).modal("show");
            }
        // --- Pobierz elementy pk do zaznaczenia
          function get_elements_to_mark(target,pks){
            var $target = target
            var $name = name
            var $pks = pks
            var $elems = [];
            $.each($pks, function( index, value ) {
              var $pk = parseInt(value);
              var $rawelem = $target+"[pk='"+$pk+"']";
              var $elem = $($rawelem);
              $elems.push($elem)
            });
            return $elems;
            }
        // --- Zaznacz wskazane
          function mark_elements(targets){
            var $targets = targets
            $.each($targets, function(index,value) {
              $(this).addClass("marked");
            });
            }
        // --- Odznacz wskazane
          function unmark_elements(targets){
            var $targets = targets
            $.each($targets, function(index,value) {
              console.log($(this))
              $(this).removeClass("marked");
            });
            }
        // --- Zaznacz jeden
          $(".mark").on("change",function(){
            var $th = $(this);
            var $pk = $th.attr("pk");
            var $url = $th.attr("url");
            var $name = $th.attr("name")
            var $checked_pks = get_checked_pks($name);
            var $unchecked_pks = get_unchecked_pks($name);
            var $mark_counter = $(".mark_counter");
            var $markons = ".markon[name='"+$name+"']";
            var $to_mark = get_elements_to_mark($markons,$checked_pks)
            var $to_unmark = get_elements_to_mark($markons,$unchecked_pks)
            mark_elements($to_mark)
            unmark_elements($to_unmark)
            set_counter($mark_counter,$checked_pks);
            });
        // --- Zaznacz wszystkie
          $(".select_all").on("click",function(){
            var $th = $(this);
            var $name = $th.attr("name")
            var $all_pks = get_all_pks($name);
            console.log($all_pks);
            var $mark_counter = $(".mark_counter");
            var $markons = ".markon[name='"+$name+"']";
            var $to_mark = get_elements_to_mark($markons,$all_pks)
            check_all($name)
            mark_elements($to_mark)
            set_counter($mark_counter,$all_pks);
            });
      
          function add_btn_color(target,cls){
            var $target = target;
            var $cls = cls;
            $target.addClass(cls);
            }
          function remove_btn_color(target,cls){
            var $target = target;
            var $class = cls;
            $target.removeClass(cls);
            }
          function check_all(name){
            var $name = name
            $.each($("input.mark[name='"+name+"']"), function(){
              $(this).prop("checked",true);
              console.log($(this));
            });
            }  
          function uncheck_all(name){
            var $name = name
            $.each($("input.mark[name='"+name+"']"), function(){
              $(this).prop("checked",false);
              console.log($(this));
            });
            }  


        // --- Odznacz wszystkie
          $(".deselect_all").on('click',function(){
            var $th = $(this);
            var $name = $th.attr("name")
            var $all_pks = get_all_pks($name);
            console.log($all_pks);
            var $mark_counter = $(".mark_counter");
            var $markons = ".markon[name='"+$name+"']";
            var $to_mark = get_elements_to_mark($markons,$all_pks)
            uncheck_all($name)
            var $checked_pks = get_checked_pks($name);
            unmark_elements($to_mark)
            set_counter($mark_counter,$checked_pks);
            });
      // Action-bar ----------------------------------
        // --- [button][opcje] Delete 
          $(".action-bar-item-link.delete").on('click',function(){
            var $th = $(this);
            var $name = $th.attr("name");
            var $url = $th.attr("url");
            var $successurl = $th.attr("successurl");
            var $checked_pks = get_checked_pks($name);
            var $data = {"pk":$checked_pks}
            if(any_is_checked($name)){
              if(confirm("Czy chcesz usunąć zaznaczone rekordy?")){
                $.ajax({
                  url:$url,
                  data:JSON.stringify($data),
                  type:'delete',
                  success: function(data){
                      console.log(data);
                      if(data.status=="OK"){
                        redirect($successurl)
                      } else {
                        alert("Błąd")
                      }
                    }
                  });
                return true;
                } else { return false; }
            } else {
              alert("Brak zaznaczonych obiektów");
            }
            });
        // --- [button][opcje] Password reset
          $(".action-bar-item-link.reset").on('click',function(){
            var $th = $(this);
            var $name = $th.attr("name");
            var $url = $th.attr("url");
            var $successurl = $th.attr("successurl");
            var $checked_pks = get_checked_pks($name);
            var $data = {"pk":$checked_pks}
            if(any_is_checked($name)){
              if(confirm("Czy chcesz zresetować hasła dla wybranych użytkowników?")){
                $.ajax({
                  url:$url,
                  data:JSON.stringify($data),
                  type:'post',
                  success: function(data){
                    alert("Wysłano prośby o resetowanie hasła")
                      console.log(data.statuses)
                    }
                  });
                return true;
                } else { return false; }
            } else {
              alert("Brak zaznaczonych obiektów");
            }
            });


        // --- [button][opcje] Dodaj użytkownika z subiekta
          $(".action-bar-item-link.add-users").on('click',function(){
            var $th = $(this);
            var $name = $th.attr("name");
            var $url = $th.attr("url");
            var $successurl = $th.attr("successurl");
            var $data = {"add_users":JSON.stringify(serialize_checked_spans($name))}
            console.log($data)
            if(any_is_checked($name)){
              if(confirm("Czy chcesz dodać wybranych użytkowników do bazy?")){
                $.ajax({
                  url:$url,
                  data:$data,
                  type:'post',
                  success: function(data){
                      console.log(data.status)
                      redirect($successurl)
                    }
                  });
                return true;
                } else { return false; }
            } else {
              alert("Brak zaznaczonych obiektów");
            }
            });
        
        // --- [button][subiekt] Prosty serailizer
          $('.subiektapi-dict-mapper-button').on('click',function(){
            var $th = $(this);
            var $endpoint = $th.attr("endpoint");
            var $template = $th.attr("template");
            var $keys = $th.attr("keys").split(",");
            var $values = $th.attr("values").split(",");
            var $payload = {}
            var $importto = $th.attr("import-to")
            var $fields = map_to_dict($keys,$values)
            $payload["fields"] = $fields
            var $parameters = {}
            $parameters["endpoint"] = $endpoint
            $parameters["template"] = $template
            $payload["parameters"] = $parameters
            console.log($payload)
            $.ajax({
              url: $subiekturl,
              type: 'POST',
              data: JSON.stringify($payload),
              success: function(data){
                console.log(data);
                $($importto).html(data);
                if($.cookie("dark-mode") == "true"){
                  enable_dark_list()
                  
                }

              }
            });
            return false;
          });
        // --- [button][subiekt] Form serializer forms,params,fields
          $('.subiekt-button-form').on('click',function(){
            var $th = $(this);
            var $endpoint = $th.attr("endpoint");
            var $template = $th.attr("template");
            var $form = $($th.attr("form"))
            var $formdata = map_form($form)
            var $parameters = {};
            var $payload = {};
            var $forms = {};
            $forms[$th.attr("form")] = {"fields":$formdata}
            $parameters["endpoint"] = $endpoint
            $parameters["template"] = $template
            $payload["parameters"] = $parameters
            $payload["fields"] = $formdata
            $payload["forms"] = $forms
            console.log($payload)
            $.ajax({
              url: $subiekturl,
              type: 'POST',
              data: JSON.stringify($payload),
              success: function(data){
                console.log(data);
                $("div#"+$endpoint).html(data);
              }
            });
            return false;
            });

        // --- Subiekt GET-LIST-FROM-FORM
        //$('.subiekt-get-list-from-form').on('click',function(){
         //  var $th = $(this);
         //  var $form = $($th.attr("form"))
         //  var $import_to = $th.attr("import-to")
         //  var $url = $form.attr("url")
         //  var $fields = map_form($form)
         //  var $payload = {};
         //  var $forms = {};
         //  $payload = {"fields":$fields}
         //  console.log($payload)
         //  $.ajax({
         //    url: $url,
         //    type: 'POST',
         //    data: JSON.stringify($payload),
         //    success: function(data){
         //      console.log(data);
         //      $($import_to).html(data);
         //    }
         //  });
         //  return false;
         //});
        // --- [button][subiekt] Form serializer data (pobiera kontent wylistowany przez searcha do odpowiedniego diva)
            $(".subiekt-get-list-from-form").on('click',function(){
              var $th = $(this);
              var $target = $th.attr("forms");
              var $url = $th.attr("url");
              //var $div = $($th.attr("div"));
              var $success_url = $th.attr("successurl");
              var $forms = $($target);
              var $modal_window = $th.attr("modal")
              var $modal_body = $("div.modal-body");
              var $data = [];
              var $import_to = $th.attr("import-to")
              $($forms).each(function( index ) {
                var $id = $(this).attr("id")
                var $content = $(this).serialize()
                var $obj = {}
                $obj[$id] = $content
                $data.push($obj)
              });
              var $serialized_data = {"data": JSON.stringify($data)};
              console.log("Dane zostały serializowane:")
              console.log($serialized_data)
              $.ajax({
                url: $url,
                data: $serialized_data,
                type:"POST",
                success: function (data) {
                    console.log(data)
                    populate_modal_body($import_to,data);
                    correct_checkboxes();
                    if($.cookie("dark-mode") == "true"){
                      enable_dark_list()
                    };
                          
                }
              });
            });

            $(".subiekt-get-list-from-div").on('click',function(){
              var $th = $(this);
              var $target = $th.attr("div-to-map");
              var $url = $th.attr("url");
              var $divs = $($target);
              var $data = [];

              $($divs).each(function( index ) {
                var $id = $(this).attr("id")
                var $content = $(this).find("input,select,textarea").serialize()
                var $obj = {}
                $obj[$id] = $content
                $data.push($obj)
              });

              var $serialized_data = {"data": JSON.stringify($data)};
              console.log("Dane zostały serializowane:")
              console.log($serialized_data)
              $.ajax({
                url: $url,
                data: $serialized_data,
                type:"POST",
                success: function (data) {
                    console.log(data)

                    if($.cookie("dark-mode") == "true"){
                      enable_dark_list()
                    };
                          
                }
              });
            });

        // # Reszta buttonow znajduje sie na plikach formularza
      // Subiekt status ------------------------------
        var status = false;
        // --- Status up
          function subiekt_status_up(){
            rect.stop();

            var $objs = $(document).find(".subiekt-status");
            var $sidebar = $(document).find("#sidebar");
            var $upperbar = $(document).find(".upper-bar");
            var $a = $(document).find("#sidebar ul li");
            var $overlay = $(document).find(".overlay");
            var $mainlogo = $(document).find("#main-logo img");
            $mainlogo.addClass("logo-up").removeClass("logo-down")
            $sidebar.css("background-color","#073027");


            $overlay.css("opacity",0)
            //$a.removeClass("text-danger")
            $a.addClass("sidebar-online")

            $objs.removeClass("status-offline");
            $objs.removeClass("status-processing");
            $objs.addClass("status-online animated flipInX");
            $objs.html("<span class='text-success'><i class='fas fas fa-cog fa-spin'></i> Subiekt online</span>");
            $objs.hide().fadeIn(500);
            $objs.addClass("animated flipInX")
            status = true
            }
        // --- Status down
          function subiekt_status_down(){
            rect.stop();

            var $objs = $(document).find(".subiekt-status");
            var $mainlogo = $(document).find("#main-logo img");
            var $sidebar = $(document).find("#sidebar");
            var $overlay = $(document).find(".overlay");
            var $a = $(document).find("#sidebar ul li");
            $mainlogo.addClass("logo-down").removeClass("logo-up")
            $overlay.css("opacity",0)
            $a.addClass("sidebar-offline")
            $mainlogo.removeClass("logo-up")
            $sidebar.css("background-color","#251515")
            $objs.removeClass("status-online")
            $objs.removeClass("status-processing")
            $objs.addClass("status-offline")
            $objs.html("<span class='text-danger d'><i class='fas fa-plug'></i> Subiekt offline</span>");
            $objs.hide().fadeIn(500);
            status = false
            }
        // --- Status checking
          function subiekt_status_checking(){
            rect.play();

            var $mainlogo = $(document).find("#main-logo img");
            var $objs = $(document).find(".subiekt-status");
            var $sidebar = $(document).find("#sidebar");
            var $a = $(document).find("#sidebar ul li");
            var $overlay = $(document).find(".overlay");
            $overlay.css("opacity",1)
            $mainlogo.addClass("logo-down").removeClass("logo-up")
            $a.addClass("sidebar-offline")
            $objs.addClass("status-processing")
            $sidebar.css("background-color","#251d15")
            $objs.removeClass("status-online")
            $objs.removeClass("status-offline")
            $objs.html("<span class='text-warning'><i class='fas fa-circle-notch fa-spin'></i> Sprawdzam subiekta</span>");
            $objs.hide().fadeIn(500)
            }

        // --- Petla sprawdzająca status
          subiekt_status_checking();

            setTimeout(function(){
              $.getJSON( "{% url 'SubiektStatus' %}", function(data) {
              if (data.status == 200) {
                subiekt_status_up()

              } else {
                subiekt_status_down()
              }
            });
            }, 1500);

          setInterval(function(){
            subiekt_status_checking();
            setTimeout(function(){
              $.getJSON( "{% url 'SubiektStatus' %}", function(data) {
              if (data.status == 200) {
                subiekt_status_up()
              } else {
                subiekt_status_down()
              }
              });
            }, 2500);}, 10000);
      
      });


  </script>


  
    

</body>